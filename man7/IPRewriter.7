.\" -*- mode: nroff -*-
.\" Generated by 'click-elem2man' from '../elements/tcpudp/iprewriter.hh:8'
.de M
.IR "\\$1" "(\\$2)\\$3"
..
.de RM
.RI "\\$1" "\\$2" "(\\$3)\\$4"
..
.TH "IPREWRITER" 7click "12/Oct/2017" "Click"
.SH "NAME"
IPRewriter \- Click element;
rewrites TCP/UDP packets' addresses and ports
.SH "SYNOPSIS"
\fBIPRewriter\fR(INPUTSPEC1, ..., INPUTSPECn [, \fIkeywords\fR])

.SH "DESCRIPTION"
Rewrites the source address, source port, destination address, and/or
destination port on TCP and UDP packets, along with their checksums.
\fBIPRewriter\fR implements the functionality of a network address/port translator
(NAPT).  See also 
.M IPAddrRewriter 7
and 
.M IPAddrPairRewriter 7 ,
which
implement Basic NAT, and 
.M TCPRewriter 7 ,
which implements NAPT plus sequence
number changes for TCP packets.
.PP
\fBIPRewriter\fR maintains a \fImapping table\fR that records how packets are
rewritten.  The mapping table is indexed by \fIflow identifier\fR, the quintuple
of source address, source port, destination address, destination port, and IP
protocol (TCP or UDP).  Each mapping contains a new flow identifier and an
output port.  Input packets with the indexed flow identifier are rewritten to
use the new flow identifier, then emitted on the output port.  A mapping is
written as follows:
.PP
.nf
\&    (SA, SP, DA, DP, PROTO) => (SA', SP', DA', DP') [*OUTPUT]
.fi
.PP
When \fBIPRewriter\fR receives a packet, it first looks up that packet in the
mapping table by flow identifier.  If the table contains a mapping for the
input packet, then the packet is rewritten according to the mapping and
emitted on the specified output port.  If there was no mapping, the packet is
handled by the INPUTSPEC corresponding to the input port on which the packet
arrived.  (There are as many input ports as INPUTSPECs.)  Most INPUTSPECs
install new mappings, so that future packets from the same TCP or UDP flow are
handled by the mapping table rather than some INPUTSPEC.  The six forms of
INPUTSPEC handle input packets as follows:
.PP



.IP "\&'drop' or 'discard'" 5
Discards input packets.
.IP "" 5
.IP "\&'pass OUTPUT'" 5
Sends input packets to output port OUTPUT.  No mappings are installed.
.IP "" 5
.IP "\&'keep FOUTPUT ROUTPUT'" 5
Installs mappings that preserve the input packet's flow ID.  Specifically,
given an input packet with flow ID (SA, SP, DA, DP, PROTO), two mappings are
installed:
.IP "" 5
.nf
\&    (SA, SP, DA, DP, PROTO) => (SA, SP, DA, DP) [*FOUTPUT]
\&    (DA, DP, SA, SP, PROTO) => (DA, DP, SA, SP) [*ROUTPUT]
.fi
.IP "" 5
Thus, the input packet is emitted on output port FOUTPUT unchanged, and
packets from the reply flow are emitted on output port ROUTPUT unchanged.
.IP "" 5

.IP "\&'pattern SADDR SPORT DADDR DPORT FOUTPUT ROUTPUT'" 5
Creates a mapping according to the given pattern, 'SADDR SPORT DADDR DPORT'.
Any pattern field may be a dash '-', in which case the packet's corresponding
field is left unchanged.  For instance, the pattern '1.0.0.1 20 - -' will
rewrite input packets' source address and port, but leave its destination
address and port unchanged.  SPORT may be a port range 'L-H'; \fBIPRewriter\fR will
choose a source port in that range so that the resulting mappings don't
conflict with any existing mappings.  The input packet's source port is
preferred, if it is available; otherwise a random port is chosen.  If no
source port is available, the packet is dropped.  To allocate source ports
sequentially (which can make testing easier), append a pound sign to the
range, as in '1024-65535#'.  To choose a random port rather than preferring
the source, append a '?'.
.IP "" 5
Say a packet with flow ID (SA, SP, DA, DP, PROTO) is received, and the
corresponding new flow ID is (SA', SP', DA', DP').  Then two mappings are
installed:
.IP "" 5
.nf
\&    (SA, SP, DA, DP, PROTO) => (SA', SP', DA', DP') [*FOUTPUT]
\&    (DA', DP', SA', SP', PROTO) => (DA, DP, SA, SP) [*ROUTPUT]
.fi
.IP "" 5
Thus, the input packet is rewritten and sent to FOUTPUT, and packets from the
reply flow are rewritten to look like part of the original flow and sent to
ROUTPUT.
.IP "" 5

.IP "\&'pattern PATNAME FOUTPUT ROUTPUT'" 5
Like 'pattern' above, but refers to named patterns defined by an
.M IPRewriterPatterns 7
element.
.IP "" 5
.IP "\&'ELEMENTNAME'" 5
Creates mappings according to instructions from the element ELEMENTNAME.  This
element must implement the IPMapper interface.  One example mapper is
.M RoundRobinIPMapper 7 .
.IP "" 5
.PP
\fBIPRewriter\fR has no mappings when first initialized.
.PP
Input packets must have their IP header annotations set.  Non-TCP and UDP
packets, and second and subsequent fragments, are dropped unless they arrive
on a 'pass' input port.  \fBIPRewriter\fR changes IP packet data and, optionally,
destination IP address annotations; see the DST_ANNO keyword argument below.
.PP
Keyword arguments determine how often stale mappings should be removed.
.PP

.IP "TCP_TIMEOUT \fItime\fR" 5
Time out TCP connections every \fItime\fR seconds. Defaults to 24 hours. This
timeout applies to TCP connections for which payload data has been seen
flowing in both directions.
.IP "" 5
.IP "TCP_DONE_TIMEOUT \fItime\fR" 5
Time out completed TCP connections every \fItime\fR seconds. Defaults to 4
minutes. FIN and RST flags mark TCP connections as complete.
.IP "" 5
.IP "TCP_NODATA_TIMEOUT \fItime\fR" 5
Time out non-bidirectional TCP connections every \fItime\fR seconds. Defaults to
5 minutes. A non-bidirectional TCP connection is one in which payload data
hasn't been seen in at least one direction. This should generally be larger
than TCP_DONE_TIMEOUT.
.IP "" 5
.IP "TCP_GUARANTEE \fItime\fR" 5
Preserve each TCP connection mapping for at least \fItime\fR seconds after each
successfully processed packet. Defaults to 5 seconds. Incoming flows are
dropped if an \fBIPRewriter\fR's mapping table is full of guaranteed flows.
.IP "" 5
.IP "UDP_TIMEOUT \fItime\fR" 5
Time out UDP connections every \fItime\fR seconds. Default is 5 minutes.
.IP "" 5
.IP "UDP_STREAMING_TIMEOUT \fItime\fR" 5
Timeout UDP streaming connections every \fItime\fR seconds. A "streaming"
connection, in contrast to an "RPC-like" connection, comprises at least 3
packets and at least one packet in each direction. Default is the UDP_TIMEOUT
setting.
.IP "" 5
.IP "UDP_GUARANTEE \fItime\fR" 5
UDP connection mappings are guaranteed to exist for \fItime\fR seconds after each successfully processed packet. Defaults to 5 seconds.
.IP "" 5
.IP "REAP_INTERVAL \fItime\fR" 5
Reap timed-out connections every \fItime\fR seconds. Default is 15 minutes.
.IP "" 5
.IP "MAPPING_CAPACITY \fIcapacity\fR" 5
Set the maximum number of mappings this rewriter can hold to \fIcapacity\fR.
\fICapacity\fR can either be an integer or the name of another rewriter-like
element, in which case this element will share the other element's capacity.
.IP "" 5
.IP "DST_ANNO" 5
Boolean. If true, then set the destination IP address annotation on passing
packets to the rewritten destination address. Default is true.
.IP "" 5
.PP

.SH "ELEMENT HANDLERS"



.IP "\fBtable_size\fR (read-only)" 5
Returns the number of mappings in this \fBIPRewriter\fR's tables.
.IP "" 5
.IP "\fBmapping_failures\fR (read-only)" 5
Returns the number of mapping failures, which can occur, for example, when the
\fBIPRewriter\fR runs out of source ports, or when a new flow is dropped because the
\fBIPRewriter\fR is full.
.IP "" 5
.IP "\fBsize\fR (read-only)" 5
Returns the number of flows in the flow set.  This is generally the same as
\&'table_size', but can be more when several rewriters share a flow set.
.IP "" 5
.IP "\fBcapacity\fR (read/write)" 5
Return or set the capacity of the flow set.  The returned value is two
space-separated numbers, where the first is the capacity and the second is the
short-term flow reservation.  When writing, the short-term reservation can be
omitted; it is then set to the minimum of 50 and one-eighth the capacity.
.IP "" 5
.IP "\fBtcp_table\fR (read-only)" 5
Returns a human-readable description of the \fBIPRewriter\fR's current TCP mapping
table. An unparsed mapping includes both directions' output ports; the
relevant output port is starred.
.IP "" 5
.IP "\fBudp_table\fR (read-only)" 5
Returns a human-readable description of the \fBIPRewriter\fR's current UDP mapping
table.
.IP "" 5
.IP "\fBtcp_lookup\fR (read)" 5
Takes a TCP flow as a space-separated
.IP "" 5
.nf
\&    saddr sport daddr dport
.fi
.IP "" 5
and attempts to find a forward mapping for that flow. If found, rewrites the
flow and returns in the same format.  Otherwise, returns nothing.
.IP "" 5

.PP

.SH "SEE ALSO"
.M TCPRewriter 7 ,
.M IPAddrRewriter 7 ,
.M IPAddrPairRewriter 7 ,
.M IPRewriterPatterns 7 ,
.M RoundRobinIPMapper 7 ,
.M FTPPortMapper 7 ,
.M ICMPRewriter 7 ,
.M ICMPPingRewriter 7

